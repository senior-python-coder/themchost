from flask import Flask, request, jsonify, redirect, url_for, session, send_from_directory
import sqlite3
import secrets
import hashlib
import datetime
import os
from functools import wraps
from werkzeug.utils import secure_filename
from mcrcon import MCRcon

app = Flask(__name__)
app.secret_key = secrets.token_hex(32)
app.config['UPLOAD_FOLDER'] = 'static/uploads'
app.config['MAX_CONTENT_LENGTH'] = 16 * 1024 * 1024
app.config['ALLOWED_EXTENSIONS'] = {'png', 'jpg', 'jpeg', 'gif'}
os.makedirs(app.config['UPLOAD_FOLDER'], exist_ok=True)

from flask_socketio import SocketIO, emit

socketio = SocketIO(app, cors_allowed_origins="*")

messages = []

@socketio.on("send_message")
def handle_message(data):
    messages.append(data)
    emit("receive_message", data, broadcast=True)



def allowed_file(filename):
    return '.' in filename and filename.rsplit('.', 1)[1].lower() in app.config['ALLOWED_EXTENSIONS']


def give_rank_to_player(minecraft_nick, rank_name):
    try:
        conn = sqlite3.connect('elitemc.db')
        c = conn.cursor()
        settings = {row[1]: row[2] for row in c.execute('SELECT * FROM settings').fetchall()}
        conn.close()
        rcon_host = settings.get('rcon_host', 'localhost')
        rcon_port = int(settings.get('rcon_port', '25575'))
        rcon_password = settings.get('rcon_password', 'your_password')
        with MCRcon(rcon_host, rcon_password, port=rcon_port) as mcr:
            command = f"lp user {minecraft_nick} parent set {rank_name}"
            response = mcr.command(command)
            return True, response
    except Exception as e:
        return False, str(e)


def init_db():
    conn = sqlite3.connect('elitemc.db')
    c = conn.cursor()
    c.execute('''CREATE TABLE IF NOT EXISTS users
                 (
                     id
                     INTEGER
                     PRIMARY
                     KEY
                     AUTOINCREMENT,
                     username
                     TEXT
                     UNIQUE
                     NOT
                     NULL,
                     email
                     TEXT
                     UNIQUE
                     NOT
                     NULL,
                     password
                     TEXT
                     NOT
                     NULL,
                     minecraft_nick
                     TEXT,
                     balance
                     REAL
                     DEFAULT
                     0,
                     is_admin
                     BOOLEAN
                     DEFAULT
                     0,
                     created_at
                     TIMESTAMP
                     DEFAULT
                     CURRENT_TIMESTAMP
                 )''')
    c.execute('''CREATE TABLE IF NOT EXISTS balance_deposits
    (
        id
        INTEGER
        PRIMARY
        KEY
        AUTOINCREMENT,
        user_id
        INTEGER,
        amount
        REAL
        NOT
        NULL,
        card_number
        TEXT
        NOT
        NULL,
        transaction_id
        TEXT
        NOT
        NULL,
        screenshot
        TEXT,
        status
        TEXT
        DEFAULT
        'pending',
        admin_comment
        TEXT,
        created_at
        TIMESTAMP
        DEFAULT
        CURRENT_TIMESTAMP,
        processed_at
        TIMESTAMP,
        processed_by
        INTEGER,
        FOREIGN
        KEY
                 (
        user_id
                 ) REFERENCES users
                 (
                     id
                 ), FOREIGN KEY
                 (
                     processed_by
                 ) REFERENCES users
                 (
                     id
                 ))''')
    # init_db funksiyasi ichiga qo'shing:

    c.execute('''CREATE TABLE IF NOT EXISTS support_tickets
    (
        id
        INTEGER
        PRIMARY
        KEY
        AUTOINCREMENT,
        user_id
        INTEGER,
        subject
        TEXT
        NOT
        NULL,
        status
        TEXT
        DEFAULT
        'open', -- open, answered, closed
        created_at
        TIMESTAMP
        DEFAULT
        CURRENT_TIMESTAMP,
        FOREIGN
        KEY
                 (
        user_id
                 ) REFERENCES users
                 (
                     id
                 )
        )''')

    c.execute('''CREATE TABLE IF NOT EXISTS support_messages
    (
        id
        INTEGER
        PRIMARY
        KEY
        AUTOINCREMENT,
        ticket_id
        INTEGER,
        user_id
        INTEGER,
        message
        TEXT
        NOT
        NULL,
        is_admin_reply
        BOOLEAN
        DEFAULT
        0,
        created_at
        TIMESTAMP
        DEFAULT
        CURRENT_TIMESTAMP,
        FOREIGN
        KEY
                 (
        ticket_id
                 ) REFERENCES support_tickets
                 (
                     id
                 ),
        FOREIGN KEY
                 (
                     user_id
                 ) REFERENCES users
                 (
                     id
                 )
        )''')
    c.execute('''CREATE TABLE IF NOT EXISTS purchases
    (
        id
        INTEGER
        PRIMARY
        KEY
        AUTOINCREMENT,
        user_id
        INTEGER,
        package_id
        INTEGER,
        amount
        REAL
        NOT
        NULL,
        package_name
        TEXT
        NOT
        NULL,
        minecraft_nick
        TEXT
        NOT
        NULL,
        status
        TEXT
        DEFAULT
        'completed',
        created_at
        TIMESTAMP
        DEFAULT
        CURRENT_TIMESTAMP,
        FOREIGN
        KEY
                 (
        user_id
                 ) REFERENCES users
                 (
                     id
                 ),
        FOREIGN KEY
                 (
                     package_id
                 ) REFERENCES packages
                 (
                     id
                 ))''')
    c.execute('''CREATE TABLE IF NOT EXISTS packages
                 (
                     id
                     INTEGER
                     PRIMARY
                     KEY
                     AUTOINCREMENT,
                     name
                     TEXT
                     NOT
                     NULL,
                     description
                     TEXT,
                     price
                     REAL
                     NOT
                     NULL,
                     duration
                     INTEGER
                     DEFAULT
                     30,
                     features
                     TEXT,
                     color
                     TEXT
                     DEFAULT
                     '#3b82f6',
                     is_active
                     BOOLEAN
                     DEFAULT
                     1
                 )''')
    c.execute('''CREATE TABLE IF NOT EXISTS settings
                 (
                     id
                     INTEGER
                     PRIMARY
                     KEY
                     AUTOINCREMENT,
                     key
                     TEXT
                     UNIQUE
                     NOT
                     NULL,
                     value
                     TEXT
                     NOT
                     NULL
                 )''')
    admin_password = hashlib.sha256('admin123'.encode()).hexdigest()
    c.execute(
        'INSERT OR IGNORE INTO users (username, email, password, minecraft_nick, is_admin, balance) VALUES (?, ?, ?, ?, ?, ?)',
        ('admin', 'admin@elitemc.uz', admin_password, 'SSmertnix', 1, 0))
    packages = [

        ('VIP', 'Boshlang\'ich daraja', 6000, 36500,
         '/wb (verstak),/ec (enderchest),/disposal (chiqindi),Auksion 7ta slot,Region limiti 3ta,Maksimal uylar 2ta',
         '#60a5fa'),


        ('VIP+', 'Kengaytirilgan VIP', 13000, 36500,
         '/anvil (sandan),/setwarp,/near,Kit VIP+,Auksion 10ta slot,Maksimal uylar 3ta', '#3b82f6'),


        ('LEGEND', 'Afsonaviy status', 21000, 36500,
         '/time set,/weather,Kit Legend,Auksion 14ta slot,Region limiti 5ta,Maksimal uylar 5ta', '#8b5cf6'),


        ('DONATOR', 'Donater status', 28000, 36500,
         '/jump,/clear (o\'zi),/afk,/anvil (rangli),Kit Donator,Auksion 20ta slot', '#d946ef'),


        ('GOLD', 'Oltin status', 35000, 36500,
         '/feed,/heal,/rename,Kit Gold,Region limiti 7ta,Auksion 30ta slot', '#eab308'),


        ('NITRO', 'Tezkor status', 43000, 36500,
         '/speed,/mute (sababli),/back,Kit Nitro,Region limiti 8ta,Auksion 40ta slot', '#f97316'),


        ('COMET', 'Kometa darajasi', 56000, 36500,
         '/bc (elon),/repair,Kit Comet,Maksimal uylar 10ta,Region limiti 9ta,Auksion 60ta slot', '#06b6d4'),


        ('HERO', 'Qahramon darajasi', 79000, 36500,
         '/mute (yechish),/prefix (o\'zgartirish),Kit Hero,Maksimal uylar 15ta,Region limiti 10ta,Auksion 70ta slot',
         '#6366f1'),


        ('ULTRA', 'Ultra imkoniyatlar', 100000, 36500,
         '/ban (sababli),/unban,/repair all,Kit Ultra,/ec [nik],Auksion 80ta slot', '#ef4444'),


        ('PRIME', 'Eng yuqori status', 200000, 36500,
         '/fly,/tags,/tpa (0 sek),Kit Prime,Cheksiz Region Limit,Auksion 120ta slot', '#10b981')
    ]
    for pkg in packages:
        c.execute(
            'INSERT OR IGNORE INTO packages (name, description, price, duration, features, color) VALUES (?, ?, ?, ?, ?, ?)',
            pkg)
    default_settings = [
        ('admin_card_number', '8600 1234 5678 9012'), ('admin_card_name', 'ADMIN ADMINOV'),
        ('site_name', 'EliteMC.uz'), ('server_ip', 'play.elitemc.uz'),
        ('rcon_host', 'localhost'), ('rcon_port', '25575'), ('rcon_password', 'your_rcon_password'),
        ('discord_link', 'https://discord.gg/elitemc'), ('instagram_link', 'https://instagram.com/elitemc.uz'),
        ('telegram_link', 'https://t.me/elitemc_uz'), ('youtube_link', 'https://youtube.com/@elitemc')
    ]
    for key, value in default_settings:
        c.execute('INSERT OR IGNORE INTO settings (key, value) VALUES (?, ?)', (key, value))
    conn.commit()
    conn.close()


def login_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'user_id' not in session:
            return redirect(url_for('login'))
        return f(*args, **kwargs)

    return decorated_function


def admin_required(f):
    @wraps(f)
    def decorated_function(*args, **kwargs):
        if 'user_id' not in session:
            return redirect(url_for('login'))
        conn = sqlite3.connect('elitemc.db')
        c = conn.cursor()
        user = c.execute('SELECT is_admin FROM users WHERE id = ?', (session['user_id'],)).fetchone()
        conn.close()
        if not user or not user[0]:
            return redirect(url_for('index'))
        return f(*args, **kwargs)

    return decorated_function


def render_page(template_content, **kwargs):
    conn = sqlite3.connect('elitemc.db')
    c = conn.cursor()
    settings = {row[1]: row[2] for row in c.execute('SELECT * FROM settings').fetchall()}
    conn.close()

    nav_user_section = ""
    if kwargs.get('logged_in'):
        nav_user_section = f"""
                <li><a href="/balance">üí∞ Balans</a></li>
                <li><a href="/profile">üë§ Profil</a></li>
                {'<li><a href="/admin">‚ö° Admin</a></li>' if kwargs.get('is_admin') else ''}
                <li><a href="/logout">üö™ Chiqish</a></li>
        """
    else:
        nav_user_section = """
                <li><a href="/login" class="btn btn-outline">üîê Kirish</a></li>
                <li><a href="/register" class="btn btn-primary">üìù Ro'yxat</a></li>
        """

    return f'''<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EliteMC.uz - O\'zbekistonning Eng Yaxshi Minecraft Serveri</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;600;700&family=Space+Grotesk:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {{
            --primary: #00ff88; --primary-glow: rgba(0, 255, 136, 0.5); --secondary: #0099ff;
            --accent: #ff0099; --dark: #0a0e1a; --dark-card: #141824; --dark-hover: #1e2330;
            --text: #e0e6ed; --text-dim: #8b92a8; --success: #00ff88; --warning: #ffaa00;
            --danger: #ff3366; --purple: #8b5cf6; --gold: #ffd700;
        }}
        * {{ margin: 0; padding: 0; box-sizing: border-box; }}
        body {{ font-family: 'Rajdhani', sans-serif; background: var(--dark); color: var(--text);
               line-height: 1.6; overflow-x: hidden; position: relative; min-height: 100vh; }}
        body::before {{ content: ''; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: linear-gradient(rgba(0, 255, 136, 0.03) 1px, transparent 1px),
                            linear-gradient(90deg, rgba(0, 255, 136, 0.03) 1px, transparent 1px);
            background-size: 50px 50px; pointer-events: none; z-index: 0;
            animation: gridMove 20s linear infinite; }}
        @keyframes gridMove {{ 0% {{ transform: translateY(0); }} 100% {{ transform: translateY(50px); }} }}
        body::after {{ content: ''; position: fixed; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle at 20% 30%, rgba(0, 255, 136, 0.08) 0%, transparent 25%),
                       radial-gradient(circle at 80% 70%, rgba(0, 153, 255, 0.08) 0%, transparent 25%),
                       radial-gradient(circle at 50% 50%, rgba(255, 0, 153, 0.05) 0%, transparent 25%);
            pointer-events: none; z-index: 0; animation: orbRotate 30s linear infinite; }}
        @keyframes orbRotate {{ 0% {{ transform: rotate(0deg); }} 100% {{ transform: rotate(360deg); }} }}
        .container {{ max-width: 1400px; margin: 0 auto; padding: 0 2rem; position: relative; z-index: 2; }}
   nav {{ 
        background: rgba(10, 14, 26, 0.95);
        backdrop-filter: blur(15px);
        border-bottom: 1px solid rgba(0, 255, 136, 0.1); 
        position: fixed;
        top: 0; 
        left: 0;
        width: 100%;
        z-index: 9999;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.8); 
    }}

    .hero {{ 
        padding: 12rem 0 6rem 0;
        text-align: center; 
        position: relative; 
        overflow: hidden; 
        margin-top: 0;
    }}
    
    main {{ padding-top: 80px; }}
        nav .container {{ display: flex; justify-content: space-between; align-items: center; padding: 1.2rem 2rem; }}
        .logo {{ font-family: 'Orbitron', sans-serif; font-size: 2rem; font-weight: 900;
                background: linear-gradient(135deg, var(--primary), var(--secondary));
                -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
                text-shadow: 0 0 30px var(--primary-glow); letter-spacing: 2px; position: relative;
                animation: logoGlow 3s ease-in-out infinite; }}
        @keyframes logoGlow {{ 0%, 100% {{ filter: brightness(1); }} 50% {{ filter: brightness(1.3); }} }}
        .logo::before {{ content: '‚öî'; margin-right: 10px; font-size: 1.5rem; animation: swordFloat 2s ease-in-out infinite; }}
        @keyframes swordFloat {{ 0%, 100% {{ transform: translateY(0) rotate(0deg); }} 50% {{ transform: translateY(-5px) rotate(5deg); }} }}
        .nav-links {{ display: flex; gap: 2rem; align-items: center; list-style: none; }}
        .nav-links a {{ color: var(--text); text-decoration: none; font-weight: 600; font-size: 1.1rem;
                       padding: 0.5rem 1.2rem; border-radius: 8px; transition: all 0.3s ease;
                       position: relative; overflow: hidden; }}
        .nav-links a::before {{ content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%;
                               background: linear-gradient(90deg, transparent, var(--primary-glow), transparent);
                               transition: left 0.5s; }}
        .nav-links a:hover::before {{ left: 100%; }}
        .nav-links a:hover {{ color: var(--primary); background: rgba(0, 255, 136, 0.1); transform: translateY(-2px); }}
        .nav-links .btn {{ background: linear-gradient(135deg, var(--primary), var(--secondary));
                          color: var(--dark); font-weight: 700; box-shadow: 0 5px 20px var(--primary-glow); }}
        .nav-links .btn:hover {{ transform: translateY(-2px) scale(1.05); box-shadow: 0 8px 30px var(--primary-glow); }}
        .hero {{ padding: 8rem 0; text-align: center; position: relative; overflow: hidden; }}
        .hero::before {{ content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
                        width: 800px; height: 800px; background: radial-gradient(circle, var(--primary-glow) 0%, transparent 70%);
                        opacity: 0.3; animation: pulse 4s ease-in-out infinite; }}
        @keyframes pulse {{ 0%, 100% {{ transform: translate(-50%, -50%) scale(1); opacity: 0.3; }}
                           50% {{ transform: translate(-50%, -50%) scale(1.2); opacity: 0.5; }} }}
        .hero h1 {{ font-family: 'Orbitron', sans-serif; font-size: 4.5rem; font-weight: 900; margin-bottom: 1.5rem;
                   background: linear-gradient(135deg, #fff, var(--primary), var(--secondary));
                   -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
                   animation: titleSlide 1s ease-out; position: relative; z-index: 1; }}
        @keyframes titleSlide {{ from {{ opacity: 0; transform: translateY(-50px); }} to {{ opacity: 1; transform: translateY(0); }} }}
        .hero p {{ font-size: 1.5rem; color: var(--text-dim); margin-bottom: 2rem; animation: fadeInUp 1s ease-out 0.3s both; }}
        @keyframes fadeInUp {{ from {{ opacity: 0; transform: translateY(30px); }} to {{ opacity: 1; transform: translateY(0); }} }}
        .server-ip {{ display: inline-block; background: linear-gradient(135deg, rgba(0, 255, 136, 0.2), rgba(0, 153, 255, 0.2));
                     padding: 1.5rem 3rem; border-radius: 15px; border: 2px solid var(--primary);
                     font-family: 'Space Grotesk', monospace; font-size: 1.8rem; font-weight: 700; color: var(--primary);
                     margin: 2rem 0; box-shadow: 0 10px 40px var(--primary-glow); animation: fadeInUp 1s ease-out 0.6s both;
                     cursor: pointer; transition: all 0.3s ease; }}
        .server-ip:hover {{ transform: scale(1.05); box-shadow: 0 15px 50px var(--primary-glow); }}
        .stats {{ display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 2rem; margin: 4rem 0; }}
        .stat-card {{ background: linear-gradient(135deg, var(--dark-card), var(--dark-hover)); padding: 2.5rem;
                     border-radius: 20px; text-align: center; border: 1px solid rgba(0, 255, 136, 0.2);
                     box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); transition: all 0.4s ease; position: relative; overflow: hidden; }}
        .stat-card::before {{ content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
                             background: linear-gradient(45deg, transparent, var(--primary-glow), transparent);
                             transform: rotate(45deg); transition: all 0.6s; opacity: 0; }}
        .stat-card:hover::before {{ opacity: 1; animation: shine 1.5s ease-in-out; }}
        @keyframes shine {{ 0% {{ transform: translateX(-100%) translateY(-100%) rotate(45deg); }}
                           100% {{ transform: translateX(100%) translateY(100%) rotate(45deg); }} }}
        .stat-card:hover {{ transform: translateY(-10px) scale(1.02); border-color: var(--primary);
                           box-shadow: 0 20px 50px rgba(0, 255, 136, 0.3); }}
        .stat-card i {{ font-size: 3.5rem; color: var(--primary); margin-bottom: 1rem; display: block;
                       animation: iconBounce 2s ease-in-out infinite; }}
        @keyframes iconBounce {{ 0%, 100% {{ transform: translateY(0); }} 50% {{ transform: translateY(-10px); }} }}
        .stat-card h3 {{ font-size: 3rem; font-weight: 800; color: var(--primary); margin: 1rem 0; font-family: 'Orbitron', sans-serif; }}
        .stat-card p {{ color: var(--text-dim); font-size: 1.1rem; font-weight: 500; }}
        .section-title {{ text-align: center; margin: 5rem 0 3rem; position: relative; }}
        .section-title h2 {{ font-family: 'Orbitron', sans-serif; font-size: 3.5rem; font-weight: 900;
                            background: linear-gradient(135deg, var(--primary), var(--secondary));
                            -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
                            position: relative; display: inline-block; }}
        .section-title h2::after {{ content: ''; position: absolute; bottom: -15px; left: 50%; transform: translateX(-50%);
                                    width: 100px; height: 4px; background: linear-gradient(90deg, transparent, var(--primary), transparent);
                                    border-radius: 2px; }}
        .packages {{ display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 2.5rem; margin: 4rem 0; }}
        .package-card {{ background: linear-gradient(135deg, var(--dark-card), var(--dark-hover)); border-radius: 25px;
                        padding: 3rem 2rem; border: 2px solid transparent; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                        position: relative; overflow: hidden; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5); }}
        .package-card::before {{ content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
                                background: linear-gradient(135deg, var(--primary-glow), rgba(0, 153, 255, 0.2));
                                opacity: 0; transition: opacity 0.4s; }}
        .package-card:hover {{ transform: translateY(-15px) scale(1.03); border-color: var(--primary);
                              box-shadow: 0 25px 60px rgba(0, 255, 136, 0.4); }}
        .package-card:hover::before {{ opacity: 0.1; }}
        .package-name {{ font-family: 'Orbitron', sans-serif; font-size: 2.5rem; font-weight: 900; margin-bottom: 1rem;
                        text-align: center; position: relative; z-index: 1; }}
        .package-price {{ font-size: 3rem; font-weight: 800; text-align: center; margin: 1.5rem 0; color: var(--primary);
                         font-family: 'Orbitron', sans-serif; position: relative; z-index: 1; }}
        .package-desc {{ text-align: center; color: var(--text-dim); margin-bottom: 2rem; font-size: 1.1rem;
                        position: relative; z-index: 1; }}
        .package-features {{ list-style: none; margin: 2rem 0; position: relative; z-index: 1; }}
        .package-features li {{ padding: 0.8rem 0; border-bottom: 1px solid rgba(255, 255, 255, 0.05);
                               display: flex; align-items: center; gap: 0.8rem; transition: all 0.3s; }}
        .package-features li:hover {{ padding-left: 10px; color: var(--primary); }}
        .package-features li i {{ color: var(--primary); font-size: 1.2rem; }}
        .package-duration {{ text-align: center; margin: 1.5rem 0; padding: 0.8rem; background: rgba(0, 255, 136, 0.1);
                            border-radius: 10px; color: var(--primary); font-weight: 600; position: relative; z-index: 1; }}
        .btn {{ display: inline-block; padding: 1rem 2.5rem; border-radius: 12px; font-weight: 700; font-size: 1.1rem;
               text-decoration: none; transition: all 0.3s ease; border: none; cursor: pointer; position: relative;
               overflow: hidden; z-index: 1; }}
        .btn::before {{ content: ''; position: absolute; top: 50%; left: 50%; width: 0; height: 0; border-radius: 50%;
                       background: rgba(255, 255, 255, 0.2); transform: translate(-50%, -50%);
                       transition: width 0.6s, height 0.6s; z-index: -1; }}
        .btn:hover::before {{ width: 300px; height: 300px; }}
        .btn-primary {{ background: linear-gradient(135deg, var(--primary), var(--secondary)); color: var(--dark);
                       box-shadow: 0 10px 30px var(--primary-glow); }}
        .btn-primary:hover {{ transform: translateY(-3px) scale(1.05); box-shadow: 0 15px 40px var(--primary-glow); }}
        .btn-secondary {{ background: linear-gradient(135deg, var(--purple), var(--accent)); color: white;
                         box-shadow: 0 10px 30px rgba(139, 92, 246, 0.4); }}
        .btn-secondary:hover {{ transform: translateY(-3px) scale(1.05); box-shadow: 0 15px 40px rgba(139, 92, 246, 0.6); }}
        .btn-outline {{ background: transparent; border: 2px solid var(--primary); color: var(--primary); }}
        .btn-outline:hover {{ background: var(--primary); color: var(--dark); transform: translateY(-3px); }}
        .btn-full {{ width: 100%; text-align: center; }}
        .form-group {{ margin-bottom: 2rem; }}
        .form-group label {{ display: block; margin-bottom: 0.8rem; color: var(--text); font-weight: 600; font-size: 1.1rem; }}
        .form-group label i {{ margin-right: 0.5rem; color: var(--primary); }}
        .form-group input, .form-group textarea, .form-group select {{
            width: 100%; padding: 1.2rem; background: rgba(255, 255, 255, 0.05); border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px; color: var(--text); font-size: 1.1rem; transition: all 0.3s; font-family: 'Rajdhani', sans-serif;
        }}
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {{
            outline: none; border-color: var(--primary); background: rgba(0, 255, 136, 0.05); box-shadow: 0 0 20px var(--primary-glow);
        }}
        .card {{ background: linear-gradient(135deg, var(--dark-card), var(--dark-hover)); border-radius: 20px; padding: 2.5rem;
                border: 1px solid rgba(0, 255, 136, 0.2); box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); margin-bottom: 2rem; }}
        .card-header {{ border-bottom: 2px solid rgba(0, 255, 136, 0.2); padding-bottom: 1.5rem; margin-bottom: 2rem; }}
        .card-header h2 {{ font-family: 'Orbitron', sans-serif; font-size: 2rem; color: var(--primary); }}
        table {{ width: 100%; border-collapse: separate; border-spacing: 0; margin: 2rem 0; }}
        table thead {{ background: linear-gradient(135deg, var(--primary), var(--secondary)); }}
        table thead th {{ padding: 1.5rem; text-align: left; color: var(--dark); font-weight: 700; font-size: 1.1rem;
                         font-family: 'Orbitron', sans-serif; }}
        table thead th:first-child {{ border-radius: 12px 0 0 0; }}
        table thead th:last-child {{ border-radius: 0 12px 0 0; }}
        table tbody tr {{ background: var(--dark-card); transition: all 0.3s; }}
        table tbody tr:hover {{ background: var(--dark-hover); transform: scale(1.01); box-shadow: 0 5px 15px rgba(0, 255, 136, 0.2); }}
        table tbody td {{ padding: 1.5rem; border-bottom: 1px solid rgba(255, 255, 255, 0.05); }}
        .badge {{ display: inline-block; padding: 0.5rem 1.2rem; border-radius: 20px; font-size: 0.9rem; font-weight: 700;
                 text-transform: uppercase; letter-spacing: 1px; }}
        .badge-pending {{ background: rgba(255, 170, 0, 0.2); color: var(--warning); border: 1px solid var(--warning); }}
        .badge-approved {{ background: rgba(0, 255, 136, 0.2); color: var(--success); border: 1px solid var(--success); }}
        .badge-rejected {{ background: rgba(255, 51, 102, 0.2); color: var(--danger); border: 1px solid var(--danger); }}
        .balance-display {{ background: linear-gradient(135deg, var(--purple), var(--accent)); padding: 3rem; border-radius: 20px;
                           text-align: center; margin: 2rem 0; box-shadow: 0 15px 40px rgba(139, 92, 246, 0.4);
                           position: relative; overflow: hidden; }}
        .balance-display::before {{ content: ''; position: absolute; top: -50%; right: -50%; width: 200%; height: 200%;
                                    background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
                                    animation: shimmer 3s infinite; }}
        @keyframes shimmer {{ 0% {{ transform: translateX(-100%) translateY(-100%) rotate(45deg); }}
                             100% {{ transform: translateX(100%) translateY(100%) rotate(45deg); }} }}
        .balance-display h3 {{ font-size: 1.3rem; margin-bottom: 1rem; opacity: 0.9; }}
        .balance-amount {{ font-family: 'Orbitron', sans-serif; font-size: 4rem; font-weight: 900; color: white;
                          text-shadow: 0 5px 20px rgba(0, 0, 0, 0.5); }}
        .alert {{ padding: 1.5rem; border-radius: 12px; margin: 2rem 0; border-left: 5px solid; display: flex;
                 align-items: center; gap: 1rem; animation: slideIn 0.5s ease-out; }}
        @keyframes slideIn {{ from {{ opacity: 0; transform: translateX(-20px); }} to {{ opacity: 1; transform: translateX(0); }} }}
        .alert-warning {{ background: rgba(255, 170, 0, 0.1); border-color: var(--warning); color: var(--warning); }}
        .alert-info {{ background: rgba(0, 153, 255, 0.1); border-color: var(--secondary); color: var(--secondary); }}
        .alert i {{ font-size: 2rem; }}
        .tabs {{ display: flex; gap: 1rem; margin: 2rem 0; flex-wrap: wrap; }}
        .tab {{ padding: 1rem 2rem; background: var(--dark-card); border: 2px solid transparent; border-radius: 12px;
               color: var(--text-dim); text-decoration: none; font-weight: 600; transition: all 0.3s; display: flex;
               align-items: center; gap: 0.5rem; }}
        .tab:hover {{ background: var(--dark-hover); color: var(--primary); border-color: var(--primary); transform: translateY(-2px); }}
        .tab.active {{ background: linear-gradient(135deg, var(--primary), var(--secondary)); color: var(--dark);
                      border-color: var(--primary); font-weight: 700; }}
        footer {{ background: linear-gradient(180deg, var(--dark), var(--dark-card)); border-top: 2px solid rgba(0, 255, 136, 0.2);
                 margin-top: 8rem; padding: 4rem 0 2rem; position: relative; }}
        footer::before {{ content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px;
                         background: linear-gradient(90deg, transparent, var(--primary), var(--secondary), var(--accent), transparent);
                         animation: lineGlow 3s ease-in-out infinite; }}
        @keyframes lineGlow {{ 0%, 100% {{ opacity: 0.5; }} 50% {{ opacity: 1; }} }}
        .footer-content {{ display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 3rem; margin-bottom: 3rem; }}
        .footer-section h3 {{ font-family: 'Orbitron', sans-serif; font-size: 1.5rem; margin-bottom: 1.5rem; color: var(--primary); }}
        .footer-section p {{ color: var(--text-dim); line-height: 1.8; margin-bottom: 1rem; }}
        .social-links {{ display: flex; gap: 1.5rem; margin-top: 2rem; }}
        .social-link {{ display: flex; align-items: center; justify-content: center; width: 50px; height: 50px;
                       background: linear-gradient(135deg, var(--dark-card), var(--dark-hover));
                       border: 2px solid rgba(0, 255, 136, 0.3); border-radius: 12px; color: var(--primary);
                       font-size: 1.5rem; transition: all 0.3s ease; text-decoration: none; }}
        .social-link:hover {{ background: linear-gradient(135deg, var(--primary), var(--secondary)); color: var(--dark);
                             transform: translateY(-5px) rotate(5deg); box-shadow: 0 10px 30px var(--primary-glow); }}
        .social-link.discord:hover {{ background: linear-gradient(135deg, #5865F2, #7289DA); box-shadow: 0 10px 30px rgba(88, 101, 242, 0.5); }}
        .social-link.instagram:hover {{ background: linear-gradient(135deg, #E1306C, #F77737, #FCAF45); box-shadow: 0 10px 30px rgba(225, 48, 108, 0.5); }}
        .social-link.telegram:hover {{ background: linear-gradient(135deg, #0088cc, #00aced); box-shadow: 0 10px 30px rgba(0, 136, 204, 0.5); }}
        .social-link.youtube:hover {{ background: linear-gradient(135deg, #FF0000, #CC0000); box-shadow: 0 10px 30px rgba(255, 0, 0, 0.5); }}
        .footer-bottom {{ text-align: center; padding-top: 2rem; border-top: 1px solid rgba(0, 255, 136, 0.1); color: var(--text-dim); }}
        .footer-bottom p {{ font-size: 1.1rem; font-weight: 500; }}
        .copyright {{ margin-top: 1rem; font-size: 0.95rem; opacity: 0.7; }}
        .notification {{ position: fixed; top: 100px; right: 2rem; background: linear-gradient(135deg, var(--dark-card), var(--dark-hover));
                        padding: 1.5rem 2rem; border-radius: 12px; border-left: 5px solid var(--primary);
                        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); z-index: 10000; animation: slideInRight 0.5s ease-out; }}
        @keyframes slideInRight {{ from {{ opacity: 0; transform: translateX(100%); }} to {{ opacity: 1; transform: translateX(0); }} }}
        .file-upload {{ position: relative; display: inline-block; width: 100%; }}
        .file-upload input[type="file"] {{ position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; }}
        .file-upload-label {{ display: block; padding: 1.5rem; background: rgba(0, 255, 136, 0.1);
                             border: 2px dashed var(--primary); border-radius: 12px; text-align: center;
                             cursor: pointer; transition: all 0.3s; }}
        .file-upload-label:hover {{ background: rgba(0, 255, 136, 0.2); border-color: var(--secondary); }}
        .file-upload-label i {{ font-size: 2rem; color: var(--primary); display: block; margin-bottom: 0.5rem; }}
        .image-preview {{ max-width: 100%; border-radius: 12px; border: 2px solid var(--primary); margin-top: 1rem; }}
        @media (max-width: 768px) {{
            .hero h1 {{ font-size: 2.5rem; }}
            .hero p {{ font-size: 1.2rem; }}
            .server-ip {{ font-size: 1.3rem; padding: 1rem 2rem; }}
            .nav-links {{ flex-direction: column; gap: 0.5rem; }}
            .stats {{ grid-template-columns: 1fr; }}
            .packages {{ grid-template-columns: 1fr; }}
            .tabs {{ flex-direction: column; }}
            table {{ font-size: 0.9rem; }}
            table thead th, table tbody td {{ padding: 1rem; }}
        }}
    </style>
</head>
<body>
    <nav>
        <div class="container">
            <div class="logo">EliteMC</div>
            <ul class="nav-links">
                <li><a href="/">üè† Asosiy</a></li>
                <li><a href="/shop">üõí Do'kon</a></li>
                {nav_user_section}
            </ul>
        </div>
    </nav>
    <main>{template_content}</main>
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>‚öîÔ∏è EliteMC.uz</h3>
                    <p>O'zbekistonning eng yaxshi va eng mashhur Minecraft serveri. Bizning serverimizda siz ajoyib o'yinchilar jamoasi bilan birga o'ynashingiz va yangi do'stlar orttirishingiz mumkin!</p>
                    <p><strong>Server IP:</strong> {settings.get('server_ip', 'play.elitemc.uz')}</p>
                </div>
                <div class="footer-section">
                    <h3>üîó Sahifalar</h3>
                    <ul style="list-style: none;">
                        <li style="margin: 0.5rem 0;"><a href="/" style="color: var(--text-dim); text-decoration: none; transition: all 0.3s;" onmouseover="this.style.color='var(--primary)'" onmouseout="this.style.color='var(--text-dim)'">üè† Bosh sahifa</a></li>
                        <li style="margin: 0.5rem 0;"><a href="/shop" style="color: var(--text-dim); text-decoration: none; transition: all 0.3s;" onmouseover="this.style.color='var(--primary)'" onmouseout="this.style.color='var(--text-dim)'">üõí Do'kon</a></li>
                        <li style="margin: 0.5rem 0;"><a href="/register" style="color: var(--text-dim); text-decoration: none; transition: all 0.3s;" onmouseover="this.style.color='var(--primary)'" onmouseout="this.style.color='var(--text-dim)'">üìù Ro'yxatdan o'tish</a></li>
                        <li style="margin: 0.5rem 0;"><a href="/login" style="color: var(--text-dim); text-decoration: none; transition: all 0.3s;" onmouseover="this.style.color='var(--primary)'" onmouseout="this.style.color='var(--text-dim)'">üîê Kirish</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h3>üì± Ijtimoiy tarmoqlar</h3>
                    <p>Bizning ijtimoiy tarmoqlarda yangiliklar va aksiyalardan birinchi bo'lib xabardor bo'ling!</p>
                    <div class="social-links">
                        <a href="{settings.get('https://discord.com/invite/EbJ2cpkwuZ', '#')}" class="social-link discord" target="_blank" title="Discord"><i class="fab fa-discord"></i></a>
                        <a href="{settings.get('https://instagram.elitemc.uz', '#')}" class="social-link instagram" target="_blank" title="Instagram"><i class="fab fa-instagram"></i></a>
                        <a href="{settings.get('https://t.me/EliteMcChannel', '#')}" class="social-link telegram" target="_blank" title="Telegram"><i class="fab fa-telegram"></i></a>
                        <a href="{settings.get('https://www.youtube.com/@SSmertnix', '#')}" class="social-link youtube" target="_blank" title="YouTube"><i class="fab fa-youtube"></i></a>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>Made with ‚ù§Ô∏è by EliteMC Team</p>
                <p class="copyright">¬© 2026 EliteMC.uz - Barcha huquqlar himoyalangan</p>
            </div>
        </div>
    </footer>
    <script>
        function showNotification(message, type = 'success') {{
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `<i class="fas fa-${{type === 'success' ? 'check-circle' : 'exclamation-circle'}}"></i><span>${{message}}</span>`;
            document.body.appendChild(notification);
            setTimeout(() => {{
                notification.style.animation = 'slideInRight 0.5s ease-out reverse';
                setTimeout(() => notification.remove(), 500);
            }}, 3000);
        }}
        async function handleFormSubmit(formId, url) {{
            const form = document.getElementById(formId);
            if (!form) return;
            form.addEventListener('submit', async (e) => {{
                e.preventDefault();
                const formData = new FormData(form);
                const data = Object.fromEntries(formData);
                try {{
                    const response = await fetch(url, {{
                        method: 'POST', headers: {{'Content-Type': 'application/json'}}, body: JSON.stringify(data)
                    }});
                    const result = await response.json();
                    if (result.success) {{
                        showNotification(result.message, 'success');
                        if (result.redirect) setTimeout(() => window.location.href = result.redirect, 1500);
                    }} else {{
                        showNotification(result.message, 'error');
                    }}
                }} catch (error) {{
                    showNotification('Xatolik yuz berdi!', 'error');
                }}
            }});
        }}
        handleFormSubmit('loginForm', '/login');
        handleFormSubmit('registerForm', '/register');
        document.querySelectorAll('input[type="file"]').forEach(input => {{
            input.addEventListener('change', function(e) {{
                const file = e.target.files[0];
                if (file && file.type.startsWith('image/')) {{
                    const reader = new FileReader();
                    reader.onload = function(e) {{
                        const preview = document.createElement('img');
                        preview.src = e.target.result;
                        preview.className = 'image-preview';
                        const container = input.closest('.form-group');
                        const existing = container.querySelector('.image-preview');
                        if (existing) existing.remove();
                        container.appendChild(preview);
                    }};
                    reader.readAsDataURL(file);
                }}
            }});
        }});
        async function approveDeposit(id) {{
            const comment = prompt('Izoh kiriting (ixtiyoriy):');
            try {{
                const response = await fetch(`/admin/approve_deposit/${{id}}`, {{
                    method: 'POST', headers: {{'Content-Type': 'application/json'}}, body: JSON.stringify({{comment}})
                }});
                const result = await response.json();
                if (result.success) {{
                    showNotification(result.message, 'success');
                    setTimeout(() => location.reload(), 1500);
                }}
            }} catch (error) {{
                showNotification('Xatolik yuz berdi!', 'error');
            }}
        }}
        async function rejectDeposit(id) {{
            const comment = prompt('Rad etish sababini kiriting:');
            if (!comment) return;
            try {{
                const response = await fetch(`/admin/reject_deposit/${{id}}`, {{
                    method: 'POST', headers: {{'Content-Type': 'application/json'}}, body: JSON.stringify({{comment}})
                }});
                const result = await response.json();
                if (result.success) {{
                    showNotification(result.message, 'success');
                    setTimeout(() => location.reload(), 1500);
                }}
            }} catch (error) {{
                showNotification('Xatolik yuz berdi!', 'error');
            }}
        }}
        async function buyRank(packageId) {{
            if (!confirm('Ushbu paketni sotib olishga ishonchingiz komilmi?')) return;
            try {{
                const response = await fetch(`/buy_rank/${{packageId}}`, {{
                    method: 'POST', headers: {{'Content-Type': 'application/json'}}
                }});
                const result = await response.json();
                if (result.success) {{
                    showNotification(result.message, 'success');
                    setTimeout(() => location.reload(), 2000);
                }} else {{
                    showNotification(result.message, 'error');
                }}
            }} catch (error) {{
                showNotification('Xatolik yuz berdi!', 'error');
            }}
        }}
        async function saveSettings() {{
            const form = document.getElementById('settingsForm');
            const formData = new FormData(form);
            const data = Object.fromEntries(formData);
            try {{
                const response = await fetch('/admin/settings', {{
                    method: 'POST', headers: {{'Content-Type': 'application/json'}}, body: JSON.stringify(data)
                }});
                const result = await response.json();
                if (result.success) showNotification(result.message, 'success');
            }} catch (error) {{
                showNotification('Xatolik yuz berdi!', 'error');
            }}
        }}
    </script>
</body>
</html>'''


@app.route('/')
def index():
    conn = sqlite3.connect('elitemc.db')
    c = conn.cursor()
    packages = c.execute('SELECT * FROM packages WHERE is_active = 1').fetchall()
    total_users = c.execute('SELECT COUNT(*) FROM users WHERE is_admin = 0').fetchone()[0]
    total_purchases = c.execute('SELECT COUNT(*) FROM purchases').fetchone()[0]
    total_revenue = c.execute('SELECT SUM(amount) FROM purchases').fetchone()[0] or 0
    conn.close()
    content = f'''
    <div class="hero">
        <div class="container">
            <h1>üéÆ EliteMC.uz</h1>
            <p>O'zbekistonning eng yaxshi Minecraft serveri!</p>
            <div class="server-ip" onclick="navigator.clipboard.writeText('play.elitemc.uz'); showNotification('Server IP nusxalandi! ‚úÖ')">play.elitemc.uz</div>
            <br><br>
            <a href="/shop" class="btn btn-primary" style="margin-top: 2rem;">üõí Do'konga o'tish</a>
        </div>
    </div>
    <div class="container">
        <div class="stats">
            <div class="stat-card"><i class="fas fa-users"></i><h3>{total_users}</h3><p>Ro'yxatdan o'tgan foydalanuvchilar</p></div>
            <div class="stat-card"><i class="fas fa-shopping-bag"></i><h3>{total_purchases}</h3><p>Amalga oshirilgan xaridlar</p></div>
            <div class="stat-card"><i class="fas fa-coins"></i><h3>{total_revenue:,.0f} so'm</h3><p>Jami daromad</p></div>
        </div>
        <div class="section-title"><h2>üéÅ Mavjud Paketlar</h2></div>
        <div class="packages">'''
    for pkg in packages:
        features = pkg[5].split(',')
        features_html = ''.join([f'<li><i class="fas fa-check-circle"></i> {f.strip()}</li>' for f in features])
        content += f'''<div class="package-card"><div class="package-name" style="color: {pkg[6]}">{pkg[1]}</div>
            <div class="package-price">{pkg[3]:,.0f} so'm</div><div class="package-desc">{pkg[2]}</div>
            <ul class="package-features">{features_html}</ul><div class="package-duration"><i class="fas fa-clock"></i> Muddat: {pkg[4]} kun</div>
            <a href="/shop" class="btn btn-primary btn-full">Sotib olish</a></div>'''
    content += '</div></div>'
    return render_page(content, logged_in='user_id' in session, is_admin=session.get('is_admin', False))


@app.route('/register', methods=['GET', 'POST'])
def register():
    if request.method == 'POST':
        data = request.json
        username, email = data.get('username'), data.get('email')
        password = hashlib.sha256(data.get('password').encode()).hexdigest()
        minecraft_nick = data.get('minecraft_nick')
        try:
            conn = sqlite3.connect('elitemc.db')
            c = conn.cursor()
            c.execute('INSERT INTO users (username, email, password, minecraft_nick) VALUES (?, ?, ?, ?)',
                      (username, email, password, minecraft_nick))
            conn.commit()
            conn.close()
            return jsonify({'success': True, 'message': "Ro'yxatdan muvaffaqiyatli o'tdingiz!", 'redirect': '/login'})
        except sqlite3.IntegrityError:
            return jsonify({'success': False, 'message': 'Bu foydalanuvchi nomi yoki email allaqachon mavjud!'})
    content = '''<div class="container" style="max-width: 500px; margin-top: 5rem; margin-bottom: 5rem;">
        <div class="card"><div class="card-header"><h2>üìù Ro'yxatdan o'tish</h2></div>
            <form id="registerForm">
                <div class="form-group"><label><i class="fas fa-user"></i> Foydalanuvchi nomi</label>
                    <input type="text" name="username" required placeholder="Ismingiz..."></div>
                <div class="form-group"><label><i class="fas fa-envelope"></i> Email</label>
                    <input type="email" name="email" required placeholder="example@mail.com"></div>
                <div class="form-group"><label><i class="fas fa-lock"></i> Parol</label>
                    <input type="password" name="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
                <div class="form-group"><label><i class="fas fa-gamepad"></i> Minecraft nick</label>
                    <input type="text" name="minecraft_nick" required placeholder="Steve"></div>
                <button type="submit" class="btn btn-primary btn-full">Ro'yxatdan o'tish</button>
            </form>
            <p style="text-align: center; margin-top: 2rem; color: var(--text-dim);">Akkountingiz bormi? 
                <a href="/login" style="color: var(--primary); text-decoration: none;">Kirish</a></p>
        </div></div>'''
    return render_page(content, logged_in=False)


@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        data = request.json
        username = data.get('username')
        password = hashlib.sha256(data.get('password').encode()).hexdigest()
        conn = sqlite3.connect('elitemc.db')
        c = conn.cursor()
        user = c.execute('SELECT * FROM users WHERE username = ? AND password = ?', (username, password)).fetchone()
        conn.close()
        if user:
            session['user_id'], session['username'], session['is_admin'] = user[0], user[1], user[6]
            return jsonify({'success': True, 'message': 'Xush kelibsiz!', 'redirect': '/profile', 'is_admin': user[6]})
        return jsonify({'success': False, 'message': "Login yoki parol noto'g'ri!"})
    content = '''<div class="container" style="max-width: 500px; margin-top: 5rem; margin-bottom: 5rem;">
        <div class="card"><div class="card-header"><h2>üîê Kirish</h2></div>
            <form id="loginForm">
                <div class="form-group"><label><i class="fas fa-user"></i> Foydalanuvchi nomi</label>
                    <input type="text" name="username" required placeholder="Ismingiz..."></div>
                <div class="form-group"><label><i class="fas fa-lock"></i> Parol</label>
                    <input type="password" name="password" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
                <button type="submit" class="btn btn-primary btn-full">Kirish</button>
            </form>
            <p style="text-align: center; margin-top: 2rem; color: var(--text-dim);">Akkountingiz yo'qmi? 
                <a href="/register" style="color: var(--primary); text-decoration: none;">Ro'yxatdan o'tish</a></p>
        </div></div>'''
    return render_page(content, logged_in=False)


@app.route('/logout')
def logout():
    session.clear()
    return redirect(url_for('index'))

@app.route('/support', methods=['GET', 'POST'])
@login_required
def support():
    conn = sqlite3.connect('elitemc.db')
    c = conn.cursor()

    if request.method == 'POST':
        subject = request.form['subject']
        c.execute("INSERT INTO support_tickets (user_id, subject) VALUES (?, ?)",
                  (session['user_id'], subject))
        conn.commit()

    tickets = c.execute("SELECT * FROM support_tickets WHERE user_id = ? ORDER BY created_at DESC",
                        (session['user_id'],)).fetchall()

    conn.close()

    content = '''
    <div class="container">
        <div class="section-title"><h2>üí¨ SUPPORT CHAT</h2></div>

        <div class="card">
            <form method="POST">
                <div class="form-group">
                    <label>üì© Yangi murojaat</label>
                    <input type="text" name="subject" placeholder="Muammoingiz..." required>
                </div>
                <button class="btn btn-primary btn-full">‚ûï Ticket ochish</button>
            </form>
        </div>

        <div class="card">
            <h3>üßæ Mening ticketlarim</h3>
            <ul style="list-style:none;">
    '''

    for t in tickets:
        status = "üü¢ Ochiq" if t[3] == "open" else "üî¥ Yopilgan"
        content += f'''
        <li style="padding:15px;border-bottom:1px solid rgba(255,255,255,.1)">
            <a href="/support/{t[0]}" style="color:#00ff88;font-weight:700;">
                #{t[0]} ‚Äî {t[2]}
            </a>
            <span style="float:right">{status}</span>
        </li>
        '''

    content += '</ul></div></div>'
    return render_page(content, logged_in=True, is_admin=session.get('is_admin'))

@app.route('/support/<int:ticket_id>', methods=['GET', 'POST'])
@login_required
def support_chat(ticket_id):
    conn = sqlite3.connect('elitemc.db')
    c = conn.cursor()

    if request.method == 'POST':
        msg = request.form['message']
        c.execute("INSERT INTO support_messages (ticket_id, user_id, message) VALUES (?, ?, ?)",
                  (ticket_id, session['user_id'], msg))
        conn.commit()

    messages = c.execute("""
        SELECT message, is_admin_reply, created_at 
        FROM support_messages WHERE ticket_id = ?
        ORDER BY created_at ASC
    """, (ticket_id,)).fetchall()

    conn.close()

    chat = '''
    <div class="container">
        <div class="section-title"><h2>üí¨ Support Chat</h2></div>

        <div class="card" style="max-height:500px;overflow:auto;">
    '''

    for msg in messages:
        align = "right" if msg[1] else "left"
        color = "#ff0099" if msg[1] else "#00ff88"

        chat += f'''
        <div style="text-align:{align};margin:12px;">
            <span style="display:inline-block;padding:12px 18px;border-radius:15px;background:{color};color:black;font-weight:700;">
                {msg[0]}
            </span>
        </div>
        '''

    chat += '''
        </div>

        <form method="POST" class="card">
            <div class="form-group">
                <input type="text" name="message" placeholder="Xabar yozing..." required>
            </div>
            <button class="btn btn-primary btn-full">üì§ Yuborish</button>
        </form>
    </div>
    '''

    return render_page(chat, logged_in=True)

@app.route('/admin/support')
@admin_required
def admin_support():
    conn = sqlite3.connect('elitemc.db')
    c = conn.cursor()

    tickets = c.execute("""
        SELECT support_tickets.id, users.username, subject, status 
        FROM support_tickets 
        JOIN users ON users.id = support_tickets.user_id
        ORDER BY created_at DESC
    """).fetchall()

    conn.close()

    content = '<div class="container"><div class="section-title"><h2>üõ† ADMIN SUPPORT</h2></div><div class="card">'

    for t in tickets:
        content += f'''
        <div style="padding:15px;border-bottom:1px solid rgba(255,255,255,.1)">
            üéü #{t[0]} | üë§ {t[1]} | üìù {t[2]} | ‚ö° {t[3]}
            <a href="/support/{t[0]}" class="btn btn-secondary" style="float:right;">Ochish</a>
        </div>
        '''

    content += '</div></div>'
    return render_page(content, logged_in=True, is_admin=True)


@app.route('/shop')
def shop():
    conn = sqlite3.connect('elitemc.db')
    c = conn.cursor()
    packages = c.execute('SELECT * FROM packages WHERE is_active = 1').fetchall()
    user_balance = 0
    if 'user_id' in session:
        user = c.execute('SELECT balance FROM users WHERE id = ?', (session['user_id'],)).fetchone()
        if user: user_balance = user[0]
    conn.close()
    content = f'''<div class="container"><div class="section-title" style="margin-top: 3rem;"><h2>üõí Do'kon</h2></div>
        {'<div class="balance-display"><h3>üí∞ Sizning balansingiz</h3><div class="balance-amount">' + f'{user_balance:,.0f}' + ' som</div></div>' if 'user_id' in session else ''}
        <div class="packages">'''
    for pkg in packages:
        features = pkg[5].split(',')
        features_html = ''.join([f'<li><i class="fas fa-check-circle"></i> {f.strip()}</li>' for f in features])
        can_buy = 'user_id' in session and user_balance >= pkg[3]
        content += f'''<div class="package-card"><div class="package-name" style="color: {pkg[6]}">{pkg[1]}</div>
            <div class="package-price">{pkg[3]:,.0f} so'm</div><div class="package-desc">{pkg[2]}</div>
            <ul class="package-features">{features_html}</ul><div class="package-duration"><i class="fas fa-clock"></i> Muddat: {pkg[4]} kun</div>'''
        if 'user_id' in session:
            if can_buy:
                content += f'<button onclick="buyRank({pkg[0]})" class="btn btn-primary btn-full">‚úÖ Sotib olish</button>'
            else:
                content += '<button disabled class="btn btn-outline btn-full" style="opacity: 0.5; cursor: not-allowed;">‚ö†Ô∏è Balans yetarli emas</button>'
                content += '<a href="/balance" class="btn btn-secondary btn-full" style="margin-top: 1rem;">üí≥ Balans to\'ldirish</a>'
        else:
            content += '<a href="/login" class="btn btn-primary btn-full">üîê Avval kirish kerak</a>'
        content += '</div>'
    content += '</div></div>'
    return render_page(content, logged_in='user_id' in session, is_admin=session.get('is_admin', False))


@app.route('/buy_rank/<int:package_id>', methods=['POST'])
@login_required
def buy_rank(package_id):
    conn = sqlite3.connect('elitemc.db')
    c = conn.cursor()
    package = c.execute('SELECT * FROM packages WHERE id = ?', (package_id,)).fetchone()
    user = c.execute('SELECT balance, minecraft_nick FROM users WHERE id = ?', (session['user_id'],)).fetchone()
    if not package:
        conn.close()
        return jsonify({'success': False, 'message': 'Paket topilmadi!'})
    if not user or user[0] < package[3]:
        conn.close()
        return jsonify({'success': False, 'message': "Balansingizda yetarli mablag' yo'q!"})
    minecraft_nick, new_balance = user[1], user[0] - package[3]
    success, rcon_response = give_rank_to_player(minecraft_nick, package[1])
    if success:
        c.execute('UPDATE users SET balance = ? WHERE id = ?', (new_balance, session['user_id']))
        c.execute(
            'INSERT INTO purchases (user_id, package_id, amount, package_name, minecraft_nick) VALUES (?, ?, ?, ?, ?)',
            (session['user_id'], package_id, package[3], package[1], minecraft_nick))
        conn.commit()
        conn.close()
        return jsonify(
            {'success': True, 'message': f'{package[1]} ranki muvaffaqiyatli berildi! Serverga qayta kiring.',
             'new_balance': new_balance})
    conn.close()
    return jsonify({'success': False, 'message': f'Rank berishda xatolik: {rcon_response}'})


@app.route('/balance')
@login_required
def balance():
    conn = sqlite3.connect('elitemc.db')
    c = conn.cursor()
    user = c.execute('SELECT * FROM users WHERE id = ?', (session['user_id'],)).fetchone()
    deposits = c.execute('SELECT * FROM balance_deposits WHERE user_id = ? ORDER BY created_at DESC',
                         (session['user_id'],)).fetchall()
    settings = {row[1]: row[2] for row in c.execute('SELECT * FROM settings').fetchall()}
    conn.close()
    content = f'''<div class="container" style="margin-top: 3rem; margin-bottom: 3rem;">
        <div class="section-title"><h2>üí∞ Balans</h2></div>
        <div class="balance-display"><h3>Joriy balans</h3><div class="balance-amount">{user[5]:,.0f} so'm</div></div>
        <div class="card"><div class="card-header"><h2>üí≥ Balansga pul qo'shish</h2></div>
            <div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i><div>
                <strong>‚ö†Ô∏è Diqqat!</strong> Pul o'tkazishdan oldin quyidagi ma'lumotlarni diqqat bilan o'qing.</div></div>
            <div class="alert alert-info"><i class="fas fa-credit-card"></i><div>
                <strong>üìã Admin karta ma'lumotlari:</strong><br>üí≥ Karta raqami: <strong>{settings['admin_card_number']}</strong><br>
                üë§ Egasi: <strong>{settings['admin_card_name']}</strong></div></div>
            <form action="/deposit_balance" method="POST" enctype="multipart/form-data">
                <div class="form-group"><label><i class="fas fa-money-bill-wave"></i> Summa (so'm)</label>
                    <input type="number" name="amount" required min="1000" placeholder="10000"></div>
                <div class="form-group"><label><i class="fas fa-credit-card"></i> Siz o'tkazgan karta raqami</label>
                    <input type="text" name="card_number" required placeholder="8600 **** **** ****"></div>
                <div class="form-group"><label><i class="fas fa-hashtag"></i> Transaksiya ID</label>
                    <input type="text" name="transaction_id" required placeholder="TXN12345678"></div>
                <div class="form-group"><label><i class="fas fa-camera"></i> To'lov skrinshoti (ixtiyoriy)</label>
                    <div class="file-upload">
                        <input type="file" name="screenshot" accept="image/*">
                        <div class="file-upload-label"><i class="fas fa-cloud-upload-alt"></i><p>Rasm yuklash uchun bosing</p></div>
                    </div></div>
                <button type="submit" class="btn btn-primary btn-full">üì§ So'rov yuborish</button>
            </form></div>
        <div class="card"><div class="card-header"><h2>üìú To'lov tarixi</h2></div><table><thead><tr>
            <th>#</th><th>Summa</th><th>Status</th><th>Sana</th><th>Izoh</th></tr></thead><tbody>'''
    for deposit in deposits:
        status_class = 'pending' if deposit[6] == 'pending' else (
            'approved' if deposit[6] == 'approved' else 'rejected')
        status_text = '‚è≥ Kutilmoqda' if deposit[6] == 'pending' else (
            '‚úÖ Tasdiqlandi' if deposit[6] == 'approved' else '‚ùå Rad etildi')
        content += f'''<tr><td>{deposit[0]}</td><td><strong>{deposit[2]:,.0f} so'm</strong></td>
            <td><span class="badge badge-{status_class}">{status_text}</span></td>
            <td>{deposit[8][:19]}</td><td>{deposit[7] or '-'}</td></tr>'''
    content += '</tbody></table></div></div>'
    return render_page(content, logged_in=True, is_admin=session.get('is_admin', False))


@app.route('/deposit_balance', methods=['POST'])
@login_required
def deposit_balance():
    amount, card_number, transaction_id = request.form.get('amount'), request.form.get('card_number'), request.form.get(
        'transaction_id')
    screenshot = None
    if 'screenshot' in request.files:
        file = request.files['screenshot']
        if file and allowed_file(file.filename):
            filename = secure_filename(f"{session['user_id']}_{datetime.datetime.now().timestamp()}_{file.filename}")
            file.save(os.path.join(app.config['UPLOAD_FOLDER'], filename))
            screenshot = f'/static/uploads/{filename}'
    conn = sqlite3.connect('elitemc.db')
    c = conn.cursor()
    c.execute(
        'INSERT INTO balance_deposits (user_id, amount, card_number, transaction_id, screenshot) VALUES (?, ?, ?, ?, ?)',
        (session['user_id'], amount, card_number, transaction_id, screenshot))
    conn.commit()
    conn.close()
    return redirect(url_for('balance'))


@app.route('/profile')
@login_required
def profile():
    conn = sqlite3.connect('elitemc.db')
    c = conn.cursor()
    user = c.execute('SELECT * FROM users WHERE id = ?', (session['user_id'],)).fetchone()
    purchases = c.execute('SELECT * FROM purchases WHERE user_id = ? ORDER BY created_at DESC',
                          (session['user_id'],)).fetchall()
    conn.close()
    content = f'''<div class="container" style="margin-top: 3rem; margin-bottom: 3rem;">
        <div class="section-title"><h2>üë§ Profil</h2></div>
        <div class="card"><div class="card-header"><h2>üìã Shaxsiy ma'lumotlar</h2></div>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem;">
                <div><p style="color: var(--text-dim); margin-bottom: 0.5rem;"><i class="fas fa-user"></i> Foydalanuvchi nomi</p>
                    <h3 style="color: var(--primary);">{user[1]}</h3></div>
                <div><p style="color: var(--text-dim); margin-bottom: 0.5rem;"><i class="fas fa-envelope"></i> Email</p>
                    <h3 style="color: var(--primary);">{user[2]}</h3></div>
                <div><p style="color: var(--text-dim); margin-bottom: 0.5rem;"><i class="fas fa-gamepad"></i> Minecraft nick</p>
                    <h3 style="color: var(--primary);">{user[4]}</h3></div>
                <div><p style="color: var(--text-dim); margin-bottom: 0.5rem;"><i class="fas fa-wallet"></i> Balans</p>
                    <h3 style="color: var(--primary);">{user[5]:,.0f} so'm</h3></div>
            </div></div>
        <div class="card"><div class="card-header"><h2>üõçÔ∏è Xaridlar tarixi</h2></div>
            {'<table><thead><tr><th>#</th><th>Paket</th><th>Summa</th><th>Sana</th><th>Status</th></tr></thead><tbody>' if purchases else '<p style="text-align: center; color: var(--text-dim); padding: 2rem;">Hali xarid qilmadingiz</p>'}'''
    for purchase in purchases:
        content += f'''<tr><td>{purchase[0]}</td><td><strong>{purchase[4]}</strong></td>
            <td>{purchase[3]:,.0f} so'm</td><td>{purchase[7][:19]}</td>
            <td><span class="badge badge-approved">‚úÖ {purchase[6]}</span></td></tr>'''
    if purchases: content += '</tbody></table>'
    content += '</div></div>'
    return render_page(content, logged_in=True, is_admin=session.get('is_admin', False))


@app.route('/admin')
@admin_required
def admin_panel():
    conn = sqlite3.connect('elitemc.db')
    c = conn.cursor()
    pending_deposits = c.execute('''SELECT bd.*, u.username, u.minecraft_nick
                                    FROM balance_deposits bd
                                             JOIN users u ON bd.user_id = u.id
                                    WHERE bd.status = 'pending'
                                    ORDER BY bd.created_at DESC''').fetchall()
    total_users = c.execute('SELECT COUNT(*) FROM users WHERE is_admin = 0').fetchone()[0]
    total_deposits = c.execute('SELECT COUNT(*) FROM balance_deposits WHERE status = "approved"').fetchone()[0]
    total_purchases = c.execute('SELECT COUNT(*) FROM purchases').fetchone()[0]
    total_revenue = c.execute('SELECT SUM(amount) FROM purchases').fetchone()[0] or 0
    conn.close()
    content = f'''<div class="container" style="margin-top: 3rem; margin-bottom: 3rem;">
        <div class="section-title"><h2>‚ö° Admin Panel</h2></div>
        <div class="stats">
            <div class="stat-card"><i class="fas fa-users"></i><h3>{total_users}</h3><p>Jami foydalanuvchilar</p></div>
            <div class="stat-card"><i class="fas fa-check-circle"></i><h3>{total_deposits}</h3><p>Tasdiqlangan to'lovlar</p></div>
            <div class="stat-card"><i class="fas fa-shopping-cart"></i><h3>{total_purchases}</h3><p>Sotilgan paketlar</p></div>
            <div class="stat-card"><i class="fas fa-dollar-sign"></i><h3>{total_revenue:,.0f}</h3><p>Jami daromad</p></div>
        </div>
        <div class="tabs">
            <a href="/admin" class="tab active"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <a href="/admin/deposits?status=all" class="tab"><i class="fas fa-credit-card"></i> To'lovlar</a>
            <a href="/admin/users" class="tab"><i class="fas fa-users"></i> Foydalanuvchilar</a>
            <a href="/admin/settings" class="tab"><i class="fas fa-cog"></i> Sozlamalar</a>
        </div>
        <div class="card"><div class="card-header"><h2>‚è≥ Kutilayotgan to'lovlar</h2></div>
            {'<table><thead><tr><th>#</th><th>Foydalanuvchi</th><th>Summa</th><th>Karta</th><th>TXN ID</th><th>Sana</th><th>Amallar</th></tr></thead><tbody>' if pending_deposits else '<p style="text-align: center; color: var(--text-dim); padding: 2rem;">Kutilayotgan tolovlar yoq</p>'}'''
    for deposit in pending_deposits:
        screenshot_btn = f'<a href="{deposit[5]}" target="_blank" class="btn btn-outline" style="padding: 0.5rem 1rem; font-size: 0.9rem;">üñºÔ∏è Skrinshot</a>' if \
        deposit[5] else ''
        content += f'''<tr><td>{deposit[0]}</td><td><strong>{deposit[11]}</strong> ({deposit[12]})</td>
            <td>{deposit[2]:,.0f} so'm</td><td>{deposit[3]}</td><td>{deposit[4]}</td><td>{deposit[8][:19]}</td>
            <td>{screenshot_btn}
                <button onclick="approveDeposit({deposit[0]})" class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.9rem;">‚úÖ Tasdiqlash</button>
                <button onclick="rejectDeposit({deposit[0]})" class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.9rem;">‚ùå Rad etish</button>
            </td></tr>'''
    if pending_deposits: content += '</tbody></table>'
    content += '</div></div>'
    return render_page(content, logged_in=True, is_admin=True)


@app.route('/admin/approve_deposit/<int:deposit_id>', methods=['POST'])
@admin_required
def approve_deposit(deposit_id):
    data = request.json
    comment = data.get('comment', '')
    conn = sqlite3.connect('elitemc.db')
    c = conn.cursor()
    deposit = c.execute('SELECT * FROM balance_deposits WHERE id = ?', (deposit_id,)).fetchone()
    if deposit and deposit[6] == 'pending':
        c.execute('UPDATE users SET balance = balance + ? WHERE id = ?', (deposit[2], deposit[1]))
        c.execute(
            'UPDATE balance_deposits SET status = ?, admin_comment = ?, processed_at = ?, processed_by = ? WHERE id = ?',
            ('approved', comment, datetime.datetime.now(), session['user_id'], deposit_id))
        conn.commit()
        conn.close()
        return jsonify({'success': True, 'message': "To'lov tasdiqlandi!"})
    conn.close()
    return jsonify({'success': False, 'message': 'Xatolik yuz berdi!'})


@app.route('/admin/reject_deposit/<int:deposit_id>', methods=['POST'])
@admin_required
def reject_deposit(deposit_id):
    data = request.json
    comment = data.get('comment', '')
    conn = sqlite3.connect('elitemc.db')
    c = conn.cursor()
    deposit = c.execute('SELECT * FROM balance_deposits WHERE id = ?', (deposit_id,)).fetchone()
    if deposit and deposit[6] == 'pending':
        c.execute(
            'UPDATE balance_deposits SET status = ?, admin_comment = ?, processed_at = ?, processed_by = ? WHERE id = ?',
            ('rejected', comment, datetime.datetime.now(), session['user_id'], deposit_id))
        conn.commit()
        conn.close()
        return jsonify({'success': True, 'message': "To'lov rad etildi!"})
    conn.close()
    return jsonify({'success': False, 'message': 'Xatolik yuz berdi!'})


@app.route('/admin/deposits')
@admin_required
def admin_deposits():
    status_filter = request.args.get('status', 'all')
    conn = sqlite3.connect('elitemc.db')
    c = conn.cursor()
    if status_filter == 'all':
        deposits = c.execute('''SELECT bd.*, u.username
                                FROM balance_deposits bd
                                         JOIN users u ON bd.user_id = u.id
                                ORDER BY bd.created_at DESC''').fetchall()
    else:
        deposits = c.execute('''SELECT bd.*, u.username
                                FROM balance_deposits bd
                                         JOIN users u ON bd.user_id = u.id
                                WHERE bd.status = ?
                                ORDER BY bd.created_at DESC''', (status_filter,)).fetchall()
    conn.close()
    content = f'''<div class="container" style="margin-top: 3rem; margin-bottom: 3rem;">
        <div class="section-title"><h2>üí≥ Barcha to'lovlar</h2></div>
        <div class="tabs">
            <a href="/admin" class="tab"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
            <a href="/admin/deposits?status=all" class="tab {'active' if status_filter == 'all' else ''}">Barchasi</a>
            <a href="/admin/deposits?status=pending" class="tab {'active' if status_filter == 'pending' else ''}">‚è≥ Kutilmoqda</a>
            <a href="/admin/deposits?status=approved" class="tab {'active' if status_filter == 'approved' else ''}">‚úÖ Tasdiqlangan</a>
            <a href="/admin/deposits?status=rejected" class="tab {'active' if status_filter == 'rejected' else ''}">‚ùå Rad etilgan</a>
        </div>
        <div class="card"><table><thead><tr><th>#</th><th>Foydalanuvchi</th><th>Summa</th><th>Karta</th><th>Status</th><th>Sana</th><th>Amallar</th></tr></thead><tbody>'''
    for deposit in deposits:
        status_class = 'pending' if deposit[6] == 'pending' else (
            'approved' if deposit[6] == 'approved' else 'rejected')
        status_text = '‚è≥ Kutilmoqda' if deposit[6] == 'pending' else (
            '‚úÖ Tasdiqlandi' if deposit[6] == 'approved' else '‚ùå Rad etildi')
        screenshot_btn = f'<a href="{deposit[5]}" target="_blank" class="btn btn-outline" style="padding: 0.5rem; font-size: 0.9rem;">üñºÔ∏è</a>' if \
        deposit[5] else ''
        content += f'''<tr><td>{deposit[0]}</td><td><strong>{deposit[11]}</strong></td><td>{deposit[2]:,.0f} so'm</td>
            <td>{deposit[3]}</td><td><span class="badge badge-{status_class}">{status_text}</span></td>
            <td>{deposit[8][:19]}</td><td>{screenshot_btn}</td></tr>'''
    content += '</tbody></table></div></div>'
    return render_page(content, logged_in=True, is_admin=True)

@app.route('/admin/support')
@admin_required
def admin_support():
    conn = sqlite3.connect('elitemc.db')
    c = conn.cursor()

    tickets = c.execute("""
        SELECT support_tickets.id, users.username, subject, status 
        FROM support_tickets 
        JOIN users ON users.id = support_tickets.user_id
        ORDER BY created_at DESC
    """).fetchall()

    conn.close()

    content = '<div class="container"><div class="section-title"><h2>üõ† ADMIN SUPPORT</h2></div><div class="card">'

    for t in tickets:
        content += f'''
        <div style="padding:15px;border-bottom:1px solid rgba(255,255,255,.1)">
            üéü #{t[0]} | üë§ {t[1]} | üìù {t[2]} | ‚ö° {t[3]}
            <a href="/support/{t[0]}" class="btn btn-secondary" style="float:right;">Ochish</a>
        </div>
        '''

    content += '</div></div>'
    return render_page(content, logged_in=True, is_admin=True)



@app.route('/admin/users')
@admin_required
def admin_users():
    conn = sqlite3.connect('elitemc.db')
    c = conn.cursor()
    users = c.execute('SELECT * FROM users ORDER BY created_at DESC').fetchall()
    conn.close()
    content = '''<div class="container" style="margin-top: 3rem; margin-bottom: 3rem;">
        <div class="section-title"><h2>üë• Foydalanuvchilar</h2></div>
        <div class="tabs"><a href="/admin" class="tab"><i class="fas fa-tachometer-alt"></i> Dashboard</a></div>
        <div class="card"><table><thead><tr><th>#</th><th>Username</th><th>Email</th><th>Minecraft</th><th>Balans</th><th>Admin</th><th>Ro'yxat</th></tr></thead><tbody>'''
    for user in users:
        content += f'''<tr><td>{user[0]}</td><td><strong>{user[1]}</strong></td><td>{user[2]}</td>
            <td>{user[4]}</td><td>{user[5]:,.0f} so'm</td><td>{'‚úÖ' if user[6] else '‚ùå'}</td><td>{user[7][:19]}</td></tr>'''
    content += '</tbody></table></div></div>'
    return render_page(content, logged_in=True, is_admin=True)


@app.route('/admin/settings', methods=['GET', 'POST'])
@admin_required
def admin_settings():
    conn = sqlite3.connect('elitemc.db')
    c = conn.cursor()
    if request.method == 'POST':
        data = request.json
        for key, value in data.items():
            c.execute('INSERT OR REPLACE INTO settings (key, value) VALUES (?, ?)', (key, value))
        conn.commit()
        conn.close()
        return jsonify({'success': True, 'message': 'Sozlamalar saqlandi!'})
    settings = {row[1]: row[2] for row in c.execute('SELECT * FROM settings').fetchall()}
    conn.close()
    content = f'''<div class="container" style="margin-top: 3rem; margin-bottom: 3rem;">
        <div class="section-title"><h2>‚öôÔ∏è Sozlamalar</h2></div>
        <div class="tabs"><a href="/admin" class="tab"><i class="fas fa-tachometer-alt"></i> Dashboard</a></div>
        <div class="card"><div class="card-header"><h2>üí≥ Admin karta ma'lumotlari</h2></div>
            <form id="settingsForm">
                <div class="form-group"><label><i class="fas fa-credit-card"></i> Karta raqami</label>
                    <input type="text" name="admin_card_number" value="{settings.get('admin_card_number', '')}" required></div>
                <div class="form-group"><label><i class="fas fa-user"></i> Karta egasi</label>
                    <input type="text" name="admin_card_name" value="{settings.get('admin_card_name', '')}" required></div>
            </form></div>
        <div class="card"><div class="card-header"><h2>üåê Sayt sozlamalari</h2></div>
            <div class="form-group"><label><i class="fas fa-globe"></i> Sayt nomi</label>
                <input type="text" name="site_name" value="{settings.get('site_name', '')}" form="settingsForm" required></div>
            <div class="form-group"><label><i class="fas fa-server"></i> Server IP</label>
                <input type="text" name="server_ip" value="{settings.get('server_ip', '')}" form="settingsForm" required></div>
        </div>
        <div class="card"><div class="card-header"><h2>üéÆ RCON sozlamalari</h2></div>
            <div class="form-group"><label><i class="fas fa-network-wired"></i> RCON Host</label>
                <input type="text" name="rcon_host" value="{settings.get('rcon_host', '')}" form="settingsForm" required></div>
            <div class="form-group"><label><i class="fas fa-plug"></i> RCON Port</label>
                <input type="number" name="rcon_port" value="{settings.get('rcon_port', '')}" form="settingsForm" required></div>
            <div class="form-group"><label><i class="fas fa-key"></i> RCON Parol</label>
                <input type="password" name="rcon_password" value="{settings.get('rcon_password', '')}" form="settingsForm" required></div>
        </div>
        <div class="card"><div class="card-header"><h2>üì± Ijtimoiy tarmoqlar</h2></div>
            <div class="form-group"><label><i class="fab fa-discord"></i> Discord Link</label>
                <input type="url" name="discord_link" value="{settings.get('discord_link', '')}" form="settingsForm" placeholder="https://discord.gg/..."></div>
            <div class="form-group"><label><i class="fab fa-instagram"></i> Instagram Link</label>
                <input type="url" name="instagram_link" value="{settings.get('instagram_link', '')}" form="settingsForm" placeholder="https://instagram.com/..."></div>
            <div class="form-group"><label><i class="fab fa-telegram"></i> Telegram Link</label>
                <input type="url" name="telegram_link" value="{settings.get('telegram_link', '')}" form="settingsForm" placeholder="https://t.me/..."></div>
            <div class="form-group"><label><i class="fab fa-youtube"></i> YouTube Link</label>
                <input type="url" name="youtube_link" value="{settings.get('youtube_link', '')}" form="settingsForm" placeholder="https://youtube.com/@..."></div>
        </div>
        <button onclick="saveSettings()" class="btn btn-primary btn-full">üíæ Saqlash</button>
    </div>'''
    return render_page(content, logged_in=True, is_admin=True)


@app.route('/static/uploads/<filename>')
def uploaded_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename)


@app.route('/api/stats')
def stats():
    conn = sqlite3.connect('elitemc.db')
    c = conn.cursor()
    total_users = c.execute('SELECT COUNT(*) FROM users WHERE is_admin = 0').fetchone()[0]
    total_purchases = c.execute('SELECT COUNT(*) FROM purchases').fetchone()[0]
    total_revenue = c.execute('SELECT SUM(amount) FROM purchases').fetchone()[0] or 0
    conn.close()
    return jsonify({'total_users': total_users, 'total_purchases': total_purchases, 'total_revenue': total_revenue})


# ---------------- SUPPORT SYSTEM START ----------------

@app.route('/support')
@login_required
def support():
    conn = sqlite3.connect('elitemc.db')
    c = conn.cursor()
    # Foydalanuvchining barcha ticketlari
    tickets = c.execute('''SELECT *
                           FROM support_tickets
                           WHERE user_id = ?
                           ORDER BY created_at DESC''',
                        (session['user_id'],)).fetchall()
    conn.close()

    content = f'''<div class="container" style="margin-top: 3rem; margin-bottom: 3rem;">
        <div class="section-title"><h2>üõ†Ô∏è Yordam Markazi</h2></div>
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
                <h3>Mening murojaatlarim</h3>
                <a href="/support/new" class="btn btn-primary"><i class="fas fa-plus"></i> Yangi ochish</a>
            </div>
            <table>
                <thead><tr><th>ID</th><th>Mavzu</th><th>Holat</th><th>Sana</th><th>Amal</th></tr></thead>
                <tbody>'''

    if not tickets:
        content += '<tr><td colspan="5" style="text-align:center;">Murojaatlar mavjud emas</td></tr>'

    for t in tickets:
        status_color = "success" if t[3] == 'open' else ("warning" if t[3] == 'answered' else "danger")
        status_text = "Ochiq" if t[3] == 'open' else ("Javob berildi" if t[3] == 'answered' else "Yopilgan")

        content += f'''<tr>
            <td>#{t[0]}</td>
            <td><strong>{t[2]}</strong></td>
            <td><span class="badge" style="border:1px solid var(--{status_color}); color:var(--{status_color})">{status_text}</span></td>
            <td>{t[4][:16]}</td>
            <td><a href="/support/{t[0]}" class="btn btn-outline" style="padding:5px 10px;">üëÅÔ∏è Ko'rish</a></td>
        </tr>'''

    content += '''</tbody></table></div></div>'''
    return render_page(content, logged_in=True, is_admin=session.get('is_admin', False))


@app.route('/support/new', methods=['GET', 'POST'])
@login_required
def new_ticket():
    if request.method == 'POST':
        subject = request.form.get('subject')
        message = request.form.get('message')

        conn = sqlite3.connect('elitemc.db')
        c = conn.cursor()
        # Ticket yaratish
        c.execute('INSERT INTO support_tickets (user_id, subject) VALUES (?, ?)', (session['user_id'], subject))
        ticket_id = c.lastrowid
        # Birinchi xabarni yozish
        c.execute('INSERT INTO support_messages (ticket_id, user_id, message) VALUES (?, ?, ?)',
                  (ticket_id, session['user_id'], message))
        conn.commit()
        conn.close()
        return redirect(url_for('view_ticket', ticket_id=ticket_id))

    content = '''<div class="container" style="max-width: 800px; margin-top: 3rem;">
        <div class="card">
            <div class="card-header"><h2>üìù Yangi murojaat</h2></div>
            <form method="POST">
                <div class="form-group">
                    <label>Mavzu</label>
                    <input type="text" name="subject" required placeholder="Masalan: To'lov o'tmadi...">
                </div>
                <div class="form-group">
                    <label>Xabar matni</label>
                    <textarea name="message" rows="5" required placeholder="Muammoni batafsil yozing..."></textarea>
                </div>
                <button type="submit" class="btn btn-primary">Yuborish</button>
                <a href="/support" class="btn btn-outline">Bekor qilish</a>
            </form>
        </div>
    </div>'''
    return render_page(content, logged_in=True, is_admin=session.get('is_admin', False))


@app.route('/support/<int:ticket_id>', methods=['GET', 'POST'])
@login_required
def view_ticket(ticket_id):
    conn = sqlite3.connect('elitemc.db')
    c = conn.cursor()

    # Xabar yuborish
    if request.method == 'POST':
        message = request.form.get('message')
        is_admin = 1 if session.get('is_admin') else 0
        c.execute('INSERT INTO support_messages (ticket_id, user_id, message, is_admin_reply) VALUES (?, ?, ?, ?)',
                  (ticket_id, session['user_id'], message, is_admin))
        # Statusni yangilash
        new_status = 'answered' if is_admin else 'open'
        c.execute('UPDATE support_tickets SET status = ? WHERE id = ?', (new_status, ticket_id))
        conn.commit()

    ticket = c.execute('SELECT * FROM support_tickets WHERE id = ?', (ticket_id,)).fetchone()

    # Xavfsizlik: faqat egasi yoki admin ko'ra oladi
    if not ticket or (ticket[1] != session['user_id'] and not session.get('is_admin')):
        conn.close()
        return redirect(url_for('support'))

    messages = c.execute('''SELECT sm.*, u.username
                            FROM support_messages sm
                                     JOIN users u ON sm.user_id = u.id
                            WHERE ticket_id = ?
                            ORDER BY sm.created_at ASC''', (ticket_id,)).fetchall()
    conn.close()

    chat_html = ''
    for msg in messages:
        # Kim yozganini aniqlash (chap yoki o'ng tomon)
        align = 'flex-end' if msg[2] == session['user_id'] else 'flex-start'
        bg_color = 'var(--primary)' if msg[2] == session['user_id'] else 'var(--dark-hover)'
        text_color = '#000' if msg[2] == session['user_id'] else 'var(--text)'
        border = 'none' if msg[2] == session['user_id'] else '1px solid var(--primary)'

        chat_html += f'''
        <div style="display:flex; justify-content:{align}; margin-bottom:1rem;">
            <div style="max-width:70%; background:{bg_color}; color:{text_color}; padding:1rem; border-radius:15px; border:{border}">
                <div style="font-size:0.8rem; opacity:0.7; margin-bottom:5px;">{msg[6]} ‚Ä¢ {msg[5][:16]}</div>
                {msg[3]}
            </div>
        </div>
        '''

    content = f'''<div class="container" style="max-width: 900px; margin-top: 3rem;">
        <div class="card">
            <div class="card-header" style="display:flex; justify-content:space-between;">
                <h2>üé´ Ticket #{ticket[0]}: {ticket[2]}</h2>
                <a href="/support" class="btn btn-outline">Orqaga</a>
            </div>
            <div style="height: 400px; overflow-y: auto; padding: 1rem; background: rgba(0,0,0,0.2); border-radius: 10px; margin-bottom: 1rem; display: flex; flex-direction: column;">
                {chat_html}
            </div>
            <form method="POST" style="display:flex; gap:1rem;">
                <input type="text" name="message" required placeholder="Xabar yozing..." style="flex:1;">
                <button type="submit" class="btn btn-primary"><i class="fas fa-paper-plane"></i></button>
            </form>
        </div>
    </div>'''
    return render_page(content, logged_in=True, is_admin=session.get('is_admin', False))


@app.route('/admin/support')
@admin_required
def admin_support_list():
    conn = sqlite3.connect('elitemc.db')
    c = conn.cursor()
    tickets = c.execute('''SELECT st.*, u.username
                           FROM support_tickets st
                                    JOIN users u ON st.user_id = u.id
                           ORDER BY CASE WHEN st.status = 'open' THEN 0 ELSE 1 END, st.created_at DESC''').fetchall()
    conn.close()

    content = f'''<div class="container" style="margin-top: 3rem;">
        <div class="section-title"><h2>‚ö° Admin Support</h2></div>
        <div class="tabs"><a href="/admin" class="tab"><i class="fas fa-tachometer-alt"></i> Dashboard</a></div>
        <div class="card">
            <table>
                <thead><tr><th>ID</th><th>User</th><th>Mavzu</th><th>Holat</th><th>Amal</th></tr></thead>
                <tbody>'''
    for t in tickets:
        status_badge = 'badge-rejected' if t[3] == 'closed' else (
            'badge-pending' if t[3] == 'open' else 'badge-approved')
        content += f'''<tr>
            <td>#{t[0]}</td>
            <td>{t[5]}</td>
            <td>{t[2]}</td>
            <td><span class="badge {status_badge}">{t[3]}</span></td>
            <td><a href="/support/{t[0]}" class="btn btn-primary">Javob berish</a></td>
        </tr>'''
    content += '</tbody></table></div></div>'
    return render_page(content, logged_in=True, is_admin=True)


# ---------------- SUPPORT SYSTEM END ----------------

if __name__ == '__main__':
    init_db()
    print("=" * 60)
    print("üéÆ EliteMC.uz Auto Donate Sayti ishga tushdi!")
    print("=" * 60)
    print("üìç URL: http://localhost:5000")
    print("üë§ Admin: admin")
    print("üîí Parol: admin123")
    print("=" * 60)
    print("‚ö†Ô∏è MCRCON sozlamalarini /admin/settings dan to'ldiring!")
    print("=" * 60)
    app.run(debug=True, host='0.0.0.0', port=5000)
